// Density correction factors based on temperature and specific gravity
// Temperature in °C, Specific Gravity at 60°F columns: 0.500 to 0.590

export const SPECIFIC_GRAVITY_VALUES = [0.500, 0.510, 0.520, 0.530, 0.540, 0.550, 0.560, 0.570, 0.580, 0.590];

// Volume Correction Factors - Complete table from 0°C to 30°C
// Density in Kg/Liter: 0.500, 0.510, 0.520, 0.530, 0.540, 0.550, 0.560, 0.570, 0.580, 0.590
export const COMBINED_TABLE: Record<number, number[]> = {
  0.0:  [1.070, 1.065, 1.060, 1.059, 1.056, 1.051, 1.050, 1.047, 1.046, 1.042],
  0.5:  [1.068, 1.063, 1.059, 1.058, 1.054, 1.050, 1.049, 1.045, 1.045, 1.041],
  1.0:  [1.066, 1.061, 1.057, 1.056, 1.053, 1.048, 1.048, 1.044, 1.044, 1.040],
  1.5:  [1.064, 1.060, 1.056, 1.055, 1.051, 1.047, 1.046, 1.043, 1.042, 1.039],
  2.0:  [1.062, 1.058, 1.054, 1.053, 1.050, 1.046, 1.045, 1.042, 1.041, 1.038],
  2.5:  [1.060, 1.056, 1.052, 1.052, 1.048, 1.044, 1.044, 1.041, 1.040, 1.037],
  3.0:  [1.059, 1.055, 1.051, 1.050, 1.047, 1.043, 1.043, 1.039, 1.039, 1.036],
  3.5:  [1.057, 1.053, 1.049, 1.048, 1.045, 1.042, 1.041, 1.038, 1.038, 1.034],
  4.0:  [1.055, 1.051, 1.048, 1.047, 1.044, 1.040, 1.040, 1.037, 1.036, 1.033],
  4.5:  [1.053, 1.050, 1.046, 1.045, 1.043, 1.039, 1.039, 1.036, 1.035, 1.032],
  5.0:  [1.051, 1.048, 1.045, 1.044, 1.041, 1.038, 1.037, 1.035, 1.034, 1.031],
  5.5:  [1.049, 1.046, 1.043, 1.042, 1.040, 1.037, 1.036, 1.033, 1.033, 1.030],
  6.0:  [1.048, 1.045, 1.041, 1.041, 1.038, 1.035, 1.035, 1.032, 1.032, 1.029],
  6.5:  [1.046, 1.043, 1.040, 1.039, 1.037, 1.034, 1.033, 1.031, 1.031, 1.028],
  7.0:  [1.044, 1.041, 1.038, 1.038, 1.035, 1.033, 1.032, 1.030, 1.029, 1.027],
  7.5:  [1.042, 1.040, 1.037, 1.036, 1.034, 1.031, 1.031, 1.029, 1.028, 1.026],
  8.0:  [1.041, 1.038, 1.035, 1.035, 1.033, 1.030, 1.030, 1.027, 1.027, 1.025],
  8.5:  [1.039, 1.036, 1.034, 1.033, 1.031, 1.029, 1.028, 1.026, 1.026, 1.024],
  9.0:  [1.037, 1.035, 1.032, 1.032, 1.030, 1.027, 1.027, 1.025, 1.025, 1.023],
  9.5:  [1.035, 1.033, 1.031, 1.030, 1.028, 1.026, 1.026, 1.024, 1.024, 1.022],
  10.0: [1.034, 1.031, 1.029, 1.029, 1.027, 1.025, 1.025, 1.023, 1.022, 1.021],
  10.5: [1.032, 1.030, 1.028, 1.027, 1.026, 1.024, 1.023, 1.022, 1.021, 1.020],
  11.0: [1.030, 1.028, 1.026, 1.026, 1.024, 1.022, 1.022, 1.020, 1.020, 1.019],
  11.5: [1.028, 1.027, 1.025, 1.024, 1.023, 1.021, 1.021, 1.019, 1.019, 1.017],
  12.0: [1.027, 1.025, 1.023, 1.023, 1.022, 1.020, 1.020, 1.018, 1.018, 1.016],
  12.5: [1.025, 1.023, 1.022, 1.021, 1.020, 1.019, 1.018, 1.017, 1.017, 1.015],
  13.0: [1.023, 1.022, 1.020, 1.020, 1.019, 1.017, 1.017, 1.016, 1.016, 1.014],
  13.5: [1.022, 1.020, 1.019, 1.019, 1.017, 1.016, 1.016, 1.015, 1.015, 1.013],
  14.0: [1.020, 1.019, 1.017, 1.017, 1.016, 1.015, 1.015, 1.014, 1.013, 1.012],
  14.5: [1.018, 1.017, 1.016, 1.016, 1.015, 1.014, 1.013, 1.012, 1.012, 1.011],
  15.0: [1.017, 1.015, 1.014, 1.014, 1.013, 1.012, 1.012, 1.011, 1.011, 1.010],
  15.5: [1.015, 1.014, 1.013, 1.013, 1.012, 1.011, 1.011, 1.010, 1.010, 1.009],
  16.0: [1.013, 1.012, 1.012, 1.011, 1.011, 1.010, 1.010, 1.009, 1.009, 1.008],
  16.5: [1.012, 1.011, 1.010, 1.010, 1.009, 1.009, 1.008, 1.008, 1.008, 1.007],
  17.0: [1.010, 1.009, 1.009, 1.008, 1.008, 1.007, 1.007, 1.007, 1.007, 1.006],
  17.5: [1.008, 1.008, 1.007, 1.007, 1.007, 1.006, 1.006, 1.006, 1.006, 1.005],
  18.0: [1.007, 1.006, 1.006, 1.006, 1.005, 1.005, 1.005, 1.004, 1.004, 1.004],
  18.5: [1.005, 1.005, 1.004, 1.004, 1.004, 1.004, 1.004, 1.003, 1.003, 1.003],
  19.0: [1.003, 1.003, 1.003, 1.003, 1.003, 1.002, 1.002, 1.002, 1.002, 1.002],
  19.5: [1.002, 1.002, 1.001, 1.001, 1.001, 1.001, 1.001, 1.001, 1.001, 1.001],
  20.0: [1.000, 1.000, 1.000, 1.000, 1.000, 1.000, 1.000, 1.000, 1.000, 1.000],
  20.5: [0.998, 0.998, 0.999, 0.999, 0.999, 0.999, 0.999, 0.999, 0.999, 0.999],
  21.0: [0.997, 0.997, 0.997, 0.997, 0.997, 0.998, 0.998, 0.998, 0.998, 0.998],
  21.5: [0.995, 0.995, 0.996, 0.996, 0.996, 0.996, 0.996, 0.997, 0.997, 0.997],
  22.0: [0.994, 0.994, 0.994, 0.994, 0.995, 0.995, 0.995, 0.996, 0.996, 0.996],
  22.5: [0.992, 0.992, 0.993, 0.993, 0.993, 0.994, 0.994, 0.994, 0.995, 0.995],
  23.0: [0.990, 0.991, 0.992, 0.992, 0.992, 0.993, 0.993, 0.993, 0.993, 0.994],
  23.5: [0.989, 0.989, 0.990, 0.990, 0.991, 0.992, 0.992, 0.992, 0.992, 0.993],
  24.0: [0.987, 0.988, 0.989, 0.989, 0.990, 0.990, 0.990, 0.991, 0.991, 0.992],
  24.5: [0.986, 0.986, 0.987, 0.988, 0.988, 0.989, 0.989, 0.990, 0.990, 0.991],
  25.0: [0.984, 0.985, 0.986, 0.986, 0.987, 0.988, 0.988, 0.989, 0.989, 0.990],
  25.5: [0.982, 0.984, 0.985, 0.985, 0.986, 0.987, 0.987, 0.988, 0.988, 0.989],
  26.0: [0.981, 0.982, 0.983, 0.983, 0.984, 0.986, 0.986, 0.987, 0.987, 0.988],
  26.5: [0.979, 0.981, 0.982, 0.982, 0.983, 0.984, 0.985, 0.986, 0.986, 0.987],
  27.0: [0.978, 0.979, 0.980, 0.981, 0.982, 0.983, 0.983, 0.985, 0.985, 0.986],
  27.5: [0.976, 0.978, 0.979, 0.979, 0.981, 0.982, 0.982, 0.984, 0.984, 0.985],
  28.0: [0.975, 0.976, 0.978, 0.978, 0.979, 0.981, 0.981, 0.982, 0.983, 0.984],
  28.5: [0.973, 0.975, 0.976, 0.977, 0.978, 0.980, 0.980, 0.981, 0.982, 0.983],
  29.0: [0.972, 0.973, 0.975, 0.975, 0.977, 0.979, 0.979, 0.980, 0.981, 0.982],
  29.5: [0.970, 0.972, 0.974, 0.974, 0.976, 0.977, 0.978, 0.979, 0.980, 0.981],
  30.0: [0.969, 0.970, 0.972, 0.973, 0.974, 0.976, 0.977, 0.978, 0.978, 0.980],
  30.5: [0.967, 0.969, 0.971, 0.971, 0.973, 0.975, 0.975, 0.977, 0.977, 0.979],
  31.0: [0.965, 0.968, 0.970, 0.970, 0.972, 0.974, 0.974, 0.976, 0.976, 0.978],
  31.5: [0.964, 0.966, 0.968, 0.969, 0.971, 0.973, 0.973, 0.975, 0.975, 0.977],
  32.0: [0.962, 0.965, 0.967, 0.967, 0.969, 0.972, 0.972, 0.974, 0.974, 0.976],
  32.5: [0.961, 0.963, 0.966, 0.966, 0.968, 0.971, 0.971, 0.973, 0.973, 0.975],
  33.0: [0.959, 0.962, 0.964, 0.965, 0.967, 0.969, 0.970, 0.972, 0.972, 0.974],
  33.5: [0.958, 0.961, 0.963, 0.964, 0.966, 0.968, 0.969, 0.971, 0.971, 0.973],
  34.0: [0.956, 0.959, 0.962, 0.962, 0.964, 0.967, 0.967, 0.970, 0.970, 0.972],
  34.5: [0.955, 0.958, 0.960, 0.961, 0.963, 0.966, 0.966, 0.969, 0.969, 0.972],
  35.0: [0.953, 0.956, 0.959, 0.960, 0.962, 0.965, 0.965, 0.968, 0.968, 0.971],
  35.5: [0.952, 0.955, 0.958, 0.958, 0.961, 0.964, 0.964, 0.967, 0.967, 0.970],
  36.0: [0.951, 0.954, 0.956, 0.957, 0.960, 0.963, 0.963, 0.966, 0.966, 0.969],
  36.5: [0.949, 0.952, 0.955, 0.956, 0.958, 0.961, 0.962, 0.965, 0.965, 0.968],
  37.0: [0.948, 0.951, 0.954, 0.955, 0.957, 0.960, 0.961, 0.963, 0.964, 0.967],
  37.5: [0.946, 0.949, 0.953, 0.953, 0.956, 0.959, 0.960, 0.962, 0.963, 0.966],
  38.0: [0.945, 0.948, 0.951, 0.952, 0.955, 0.958, 0.959, 0.961, 0.962, 0.965],
  38.5: [0.943, 0.947, 0.950, 0.951, 0.954, 0.957, 0.957, 0.960, 0.961, 0.964],
  39.0: [0.942, 0.945, 0.949, 0.949, 0.952, 0.956, 0.956, 0.959, 0.960, 0.963],
  39.5: [0.940, 0.944, 0.947, 0.948, 0.951, 0.955, 0.955, 0.958, 0.959, 0.962],
  40.0: [0.939, 0.943, 0.946, 0.947, 0.950, 0.954, 0.954, 0.957, 0.958, 0.961],
  40.5: [0.938, 0.941, 0.945, 0.946, 0.949, 0.953, 0.953, 0.956, 0.957, 0.960],
  41.0: [0.936, 0.940, 0.944, 0.944, 0.948, 0.951, 0.952, 0.955, 0.956, 0.959],
  41.5: [0.935, 0.939, 0.942, 0.943, 0.946, 0.950, 0.951, 0.954, 0.955, 0.958],
  42.0: [0.933, 0.937, 0.941, 0.942, 0.945, 0.949, 0.950, 0.953, 0.954, 0.957],
  42.5: [0.932, 0.936, 0.940, 0.941, 0.944, 0.948, 0.949, 0.952, 0.953, 0.957],
  43.0: [0.930, 0.935, 0.939, 0.939, 0.943, 0.947, 0.948, 0.951, 0.952, 0.956],
  43.5: [0.929, 0.933, 0.937, 0.938, 0.942, 0.946, 0.947, 0.950, 0.951, 0.955],
  44.0: [0.928, 0.932, 0.936, 0.937, 0.941, 0.945, 0.946, 0.949, 0.950, 0.954],
  44.5: [0.926, 0.931, 0.935, 0.936, 0.939, 0.944, 0.944, 0.948, 0.949, 0.953],
  45.0: [0.925, 0.929, 0.934, 0.935, 0.938, 0.943, 0.943, 0.947, 0.948, 0.952],
  45.5: [0.923, 0.928, 0.932, 0.933, 0.937, 0.942, 0.942, 0.946, 0.947, 0.951],
  46.0: [0.922, 0.927, 0.931, 0.932, 0.936, 0.941, 0.941, 0.945, 0.946, 0.950],
  46.5: [0.921, 0.925, 0.930, 0.931, 0.935, 0.939, 0.940, 0.944, 0.945, 0.949],
  47.0: [0.919, 0.924, 0.929, 0.930, 0.934, 0.938, 0.939, 0.943, 0.944, 0.948],
  47.5: [0.918, 0.923, 0.927, 0.929, 0.932, 0.937, 0.938, 0.942, 0.943, 0.947],
  48.0: [0.917, 0.921, 0.926, 0.927, 0.931, 0.936, 0.937, 0.941, 0.942, 0.946],
  48.5: [0.915, 0.920, 0.925, 0.926, 0.930, 0.935, 0.936, 0.940, 0.941, 0.946],
  49.0: [0.914, 0.919, 0.924, 0.925, 0.929, 0.934, 0.935, 0.939, 0.940, 0.945],
  49.5: [0.912, 0.918, 0.923, 0.924, 0.928, 0.933, 0.934, 0.938, 0.939, 0.944],
  50.0: [0.911, 0.916, 0.921, 0.923, 0.927, 0.932, 0.933, 0.937, 0.938, 0.943],
  50.5: [0.910, 0.915, 0.920, 0.921, 0.926, 0.931, 0.932, 0.936, 0.937, 0.942],
  51.0: [0.908, 0.914, 0.919, 0.920, 0.924, 0.930, 0.931, 0.935, 0.936, 0.941],
  51.5: [0.907, 0.912, 0.918, 0.919, 0.923, 0.929, 0.930, 0.934, 0.935, 0.940],
  52.0: [0.906, 0.911, 0.917, 0.918, 0.922, 0.928, 0.929, 0.933, 0.934, 0.939],
  52.5: [0.904, 0.910, 0.915, 0.917, 0.921, 0.927, 0.928, 0.932, 0.933, 0.938],
  53.0: [0.903, 0.909, 0.914, 0.915, 0.920, 0.926, 0.927, 0.931, 0.932, 0.938],
  53.5: [0.902, 0.907, 0.913, 0.914, 0.919, 0.925, 0.926, 0.931, 0.931, 0.937],
  54.0: [0.900, 0.906, 0.912, 0.913, 0.918, 0.924, 0.925, 0.930, 0.930, 0.936],
  54.5: [0.899, 0.905, 0.911, 0.912, 0.917, 0.923, 0.924, 0.929, 0.929, 0.935],
  55.0: [0.898, 0.904, 0.909, 0.911, 0.916, 0.922, 0.923, 0.928, 0.929, 0.934],
  55.5: [0.897, 0.902, 0.908, 0.910, 0.914, 0.921, 0.921, 0.927, 0.928, 0.933],
  56.0: [0.895, 0.901, 0.907, 0.908, 0.913, 0.920, 0.920, 0.926, 0.927, 0.932],
  56.5: [0.894, 0.900, 0.906, 0.907, 0.912, 0.919, 0.919, 0.925, 0.926, 0.931],
  57.0: [0.893, 0.899, 0.905, 0.906, 0.911, 0.917, 0.918, 0.924, 0.925, 0.930],
  57.5: [0.891, 0.898, 0.904, 0.905, 0.910, 0.916, 0.917, 0.923, 0.924, 0.930],
  58.0: [0.890, 0.896, 0.902, 0.904, 0.909, 0.915, 0.916, 0.922, 0.923, 0.929],
  58.5: [0.889, 0.895, 0.901, 0.903, 0.908, 0.914, 0.915, 0.921, 0.922, 0.928],
  59.0: [0.887, 0.894, 0.900, 0.902, 0.907, 0.913, 0.914, 0.920, 0.921, 0.927],
  59.5: [0.886, 0.893, 0.899, 0.900, 0.906, 0.912, 0.913, 0.919, 0.920, 0.926],
  60.0: [0.885, 0.891, 0.898, 0.899, 0.905, 0.911, 0.912, 0.918, 0.919, 0.925],
};

export const TEMPERATURES = Object.keys(COMBINED_TABLE).map(Number).sort((a, b) => a - b);

/**
 * Lookup density correction factor (VCF) based on temperature and specific gravity
 * Uses bilinear interpolation for values between table entries
 */
export function lookupDensity(temperature: number, specificGravity: number): number {
  // Clamp values to full table range (0°C - 60°C)
  const clampedTemp = Math.max(0, Math.min(60.0, temperature));
  const clampedSG = Math.max(0.500, Math.min(0.590, specificGravity));

  // Find surrounding temperature rows
  const tempIndex = TEMPERATURES.findIndex(t => t >= clampedTemp);
  const lowerTempIdx = tempIndex === 0 ? 0 : tempIndex - 1;
  const upperTempIdx = tempIndex === -1 ? TEMPERATURES.length - 1 : tempIndex;
  
  const lowerTemp = TEMPERATURES[lowerTempIdx] ?? TEMPERATURES[0];
  const upperTemp = TEMPERATURES[upperTempIdx] ?? TEMPERATURES[TEMPERATURES.length - 1];

  // Find surrounding SG columns
  const sgIndex = SPECIFIC_GRAVITY_VALUES.findIndex(sg => sg >= clampedSG);
  const lowerSGIdx = sgIndex === 0 ? 0 : sgIndex - 1;
  const upperSGIdx = sgIndex === -1 ? SPECIFIC_GRAVITY_VALUES.length - 1 : sgIndex;

  const lowerSG = SPECIFIC_GRAVITY_VALUES[lowerSGIdx] ?? SPECIFIC_GRAVITY_VALUES[0];
  const upperSG = SPECIFIC_GRAVITY_VALUES[upperSGIdx] ?? SPECIFIC_GRAVITY_VALUES[SPECIFIC_GRAVITY_VALUES.length - 1];

  // Get the four surrounding values from combined table
  const v00 = COMBINED_TABLE[lowerTemp][lowerSGIdx];
  const v01 = COMBINED_TABLE[lowerTemp][upperSGIdx];
  const v10 = COMBINED_TABLE[upperTemp][lowerSGIdx];
  const v11 = COMBINED_TABLE[upperTemp][upperSGIdx];

  // Bilinear interpolation
  const tempRatio = upperTemp === lowerTemp ? 0 : (clampedTemp - lowerTemp) / (upperTemp - lowerTemp);
  const sgRatio = upperSG === lowerSG ? 0 : (clampedSG - lowerSG) / (upperSG - lowerSG);

  const v0 = v00 + (v01 - v00) * sgRatio;
  const v1 = v10 + (v11 - v10) * sgRatio;
  
  return v0 + (v1 - v0) * tempRatio;
}

/**
 * Calculate corrected density in kg/L
 * @param specificGravity - Specific gravity at 60°F
 * @param temperature - Temperature in °C
 * @returns Corrected density in kg/L
 */
export function calculateCorrectedDensity(specificGravity: number, temperature: number): number {
  const correctionFactor = lookupDensity(temperature, specificGravity);
  return specificGravity * correctionFactor;
}
